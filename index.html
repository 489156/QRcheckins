<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <title>êµìœ¡ ì¶œì„ì²´í¬</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      height:100%;
      overflow:hidden;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      display:flex; justify-content:center; align-items:center;
      -webkit-tap-highlight-color:transparent;
      padding:20px;
    }
    .container {
      background:#fff; border-radius:20px; padding:30px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      width:100%; max-width:400px; position:relative;
      overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .event-badge {
      display:inline-block; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff; padding:10px 20px; border-radius:20px;
      font-size:16px; font-weight:bold; margin-bottom:20px;
    }
    .title { font-size:24px; color:#333; margin-bottom:20px; font-weight:bold; text-align:center; }
    .error-page {
      display:none; background:#f8d7da; border:1px solid #f5c6cb;
      padding:20px; border-radius:10px; text-align:center; margin-bottom:20px;
    }
    .error-page h2 { color:#721c24; margin-bottom:10px; }
    form { margin-bottom:20px; }
    .input-group { margin-bottom:20px; }
    label { display:block; font-size:16px; color:#555; margin-bottom:8px; }
    input[type="tel"] {
      width:100%; padding:12px; font-size:16px;
      border:2px solid #ddd; border-radius:8px; text-align:center;
    }
    input[type="tel"]:focus {
      outline:none; border-color:#667eea; box-shadow:0 0 8px rgba(102,126,234,0.3);
    }
    .submit-btn {
      width:100%; padding:12px; font-size:18px; font-weight:bold;
      color:#fff; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      border:none; border-radius:8px; cursor:pointer;
    }
    .submit-btn:disabled {
      background:#ccc; cursor:not-allowed;
    }
    .message {
      display:none; margin-top:20px; padding:12px; border-radius:8px; font-weight:bold;
    }
    .message.success { background:#d4edda; color:#155724; }
    .message.error { background:#f8d7da; color:#721c24; }
    .info { display:none; font-size:14px; color:#666; text-align:center; }
    @media(max-width:480px){
      .container { padding:20px; }
      .title { font-size:20px; }
      input[type="tel"], .submit-btn { font-size:16px; padding:10px; }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div id="eventBadge" class="event-badge"></div>
    <div class="title">ğŸ“‹ êµìœ¡ ì¶œì„ì²´í¬</div>
    <div id="errorPage" class="error-page">
      <h2>âš ï¸ ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h2>
      <p>ì˜¬ë°”ë¥¸ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì ‘ì†í•´ì£¼ì„¸ìš”.</p>
    </div>
    <form id="attendanceForm" style="display:none;">
      <div class="input-group">
        <label for="phone">íœ´ëŒ€ì „í™”ë²ˆí˜¸</label>
        <input type="tel" id="phone" inputmode="numeric" placeholder="010-1234-5678" maxlength="13" autocomplete="off" required>
      </div>
      <button type="submit" id="submitBtn" class="submit-btn">ì¶œì„ í™•ì¸</button>
    </form>
    <div id="message" class="message"></div>
    <div id="infoSection" class="info">
      íœ´ëŒ€ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì¶œì„ì²´í¬ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.<br>í•˜ì´í”ˆ(-)ì€ ìˆì–´ë„ ì—†ì–´ë„ ë©ë‹ˆë‹¤.
    </div>
  </div>

  <script>
    (function() {
      const STORAGE_KEY = 'qrcheckins_attendanceData';
      let studentList = {};
      // ë””ë°”ì´ìŠ¤ ID ìƒì„±/ì¡°íšŒ (í´ë¦¬í•„ ì§€ì›)
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        if (crypto.randomUUID) deviceId = crypto.randomUUID();
        else deviceId = 'id-' + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
        localStorage.setItem('deviceId', deviceId);
      }
      const eventNames = {
        day1_morning:'1ì¼ì°¨ ì˜¤ì „ (09:00)',
        day1_evening:'1ì¼ì°¨ ì˜¤í›„ (17:30)',
        day2_morning:'2ì¼ì°¨ ì˜¤ì „ (09:00)',
        day2_evening:'2ì¼ì°¨ ì˜¤í›„ (17:30)'
      };
      const currentEvent = new URLSearchParams(location.search).get('event');

      // ë©”ì‹œì§€ í‘œì‹œ
      function showMessage(txt, type) {
        const msg = document.getElementById('message');
        msg.textContent = txt;
        msg.className = 'message ' + type;
        msg.style.display = 'block';
        if (type === 'success') {
          document.getElementById('submitBtn').disabled = true;
          setTimeout(()=> location.reload(), 2000);
        }
      }

      // í˜ì´ì§€ ì´ˆê¸°í™”
      function init() {
        if (!eventNames[currentEvent]) {
          document.getElementById('errorPage').style.display = 'block';
          return;
        }
        document.getElementById('eventBadge').textContent = eventNames[currentEvent];
        document.getElementById('attendanceForm').style.display = 'block';
        document.getElementById('infoSection').style.display = 'block';
        document.getElementById('attendanceForm').addEventListener('submit', onSubmit);
      }

      // ì¶œì„ ì œì¶œ
      function onSubmit(e) {
        e.preventDefault();
        const raw = document.getElementById('phone').value;
        const phone = raw.replace(/[^0-9]/g,'');
        if (phone.length !== 11 || !phone.startsWith('010')) {
          return showMessage('ì˜¬ë°”ë¥¸ íœ´ëŒ€ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        }
        const name = studentList[phone];
        if (!name) {
          return showMessage('ë“±ë¡ë˜ì§€ ì•Šì€ íœ´ëŒ€ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error');
        }
        // ì½ê¸°
        let data = {};
        try { data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
        catch { data = {}; }
        // ì¤‘ë³µ ë””ë°”ì´ìŠ¤ ì²´í¬
        for (const rec of Object.values(data)) {
          if (rec.events[currentEvent] && rec.events[currentEvent].deviceId === deviceId) {
            return showMessage('ì´ë¯¸ ì´ ê¸°ê¸°ë¡œ ë‹¤ë¥¸ êµìœ¡ìƒì´ ì¶œì„í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        }
        // ì¤‘ë³µ ë²ˆí˜¸ ì²´í¬
        if (data[phone]?.events?.[currentEvent]) {
          return showMessage(name + 'ë‹˜ì€ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.', 'error');
        }
        // ì €ì¥
        const now = new Date();
        const ts = (now.getMonth()+1).toString().padStart(2,'0') + '/'
                 + now.getDate().toString().padStart(2,'0') + ', '
                 + now.getHours().toString().padStart(2,'0') + ':'
                 + now.getMinutes().toString().padStart(2,'0');
        if (!data[phone]) data[phone] = { name, events:{} };
        data[phone].events[currentEvent] = { timestamp:ts, deviceId };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        showMessage(name + 'ë‹˜, ì¶œì„ ì™„ë£Œ ('+ts+')', 'success');
      }

      // JSONP ì½œë°±
      window.handleStudentList = function(list) {
        studentList = list;
        init();
      };

      // JSONP ë¡œë“œ with cache bust
      document.addEventListener('DOMContentLoaded', ()=> {
        const s = document.createElement('script');
        s.src = 'https://script.google.com/macros/s/AKfycbwHysYm9ipYAUU6kF6xPy_xSCF5FoJ0jvCCMzXbNs6BNwxrkMNI3_D4hfcjt_BqBe5NUA/exec'
              + '?callback=handleStudentList&ts=' + Date.now();
        s.onload = ()=> console.log('ëª…ë‹¨ ë¡œë“œ ì™„ë£Œ');
        s.onerror = ()=> showMessage('ëª…ë‹¨ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
        document.body.appendChild(s);
      });
    })();
  </script>
</body>
</html>
