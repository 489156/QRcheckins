<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <title>교육 출석체크</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      height:100%;
      overflow:hidden;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      display:flex; justify-content:center; align-items:center;
      -webkit-tap-highlight-color:transparent;
      padding:20px;
    }
    .container {
      background:#fff; border-radius:20px; padding:30px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      width:100%; max-width:400px; position:relative;
      overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .event-badge {
      display:inline-block; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff; padding:10px 20px; border-radius:20px;
      font-size:16px; font-weight:bold; margin-bottom:20px;
    }
    .title { font-size:24px; color:#333; margin-bottom:20px; font-weight:bold; text-align:center; }
    .error-page {
      display:none; background:#f8d7da; border:1px solid #f5c6cb;
      padding:20px; border-radius:10px; text-align:center; margin-bottom:20px;
    }
    .error-page h2 { color:#721c24; margin-bottom:10px; }
    form { margin-bottom:20px; }
    .input-group { margin-bottom:20px; }
    label { display:block; font-size:16px; color:#555; margin-bottom:8px; }
    input[type="tel"] {
      width:100%; padding:12px; font-size:16px;
      border:2px solid #ddd; border-radius:8px; text-align:center;
    }
    input[type="tel"]:focus {
      outline:none; border-color:#667eea; box-shadow:0 0 8px rgba(102,126,234,0.3);
    }
    .submit-btn {
      width:100%; padding:12px; font-size:18px; font-weight:bold;
      color:#fff; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      border:none; border-radius:8px; cursor:pointer;
    }
    .submit-btn:disabled {
      background:#ccc; cursor:not-allowed;
    }
    .message {
      display:none; margin-top:20px; padding:12px; border-radius:8px; font-weight:bold;
    }
    .message.success { background:#d4edda; color:#155724; }
    .message.error { background:#f8d7da; color:#721c24; }
    .info { display:none; font-size:14px; color:#666; text-align:center; }
    @media(max-width:480px){
      .container { padding:20px; }
      .title { font-size:20px; }
      input[type="tel"], .submit-btn { font-size:16px; padding:10px; }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div id="eventBadge" class="event-badge"></div>
    <div class="title">📋 교육 출석체크</div>
    <div id="errorPage" class="error-page">
      <h2>⚠️ 잘못된 접근입니다</h2>
      <p>올바른 QR코드를 스캔하여 접속해주세요.</p>
    </div>
    <form id="attendanceForm" style="display:none;">
      <div class="input-group">
        <label for="phone">휴대전화번호</label>
        <input type="tel" id="phone" inputmode="numeric" placeholder="010-1234-5678" maxlength="13" autocomplete="off" required>
      </div>
      <button type="submit" id="submitBtn" class="submit-btn">출석 확인</button>
    </form>
    <div id="message" class="message"></div>
    <div id="infoSection" class="info">
      휴대전화번호를 입력하여 출석체크를 완료해주세요.<br>하이픈(-)은 있어도 없어도 됩니다.
    </div>
  </div>

  <script>
    (function() {
      const STORAGE_KEY = 'qrcheckins_attendanceData';
      let studentList = {};
      // 디바이스 ID 생성/조회 (폴리필 지원)
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        if (crypto.randomUUID) deviceId = crypto.randomUUID();
        else deviceId = 'id-' + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
        localStorage.setItem('deviceId', deviceId);
      }
      const eventNames = {
        day1_morning:'1일차 오전 (09:00)',
        day1_evening:'1일차 오후 (17:30)',
        day2_morning:'2일차 오전 (09:00)',
        day2_evening:'2일차 오후 (17:30)'
      };
      const currentEvent = new URLSearchParams(location.search).get('event');

      // 메시지 표시
      function showMessage(txt, type) {
        const msg = document.getElementById('message');
        msg.textContent = txt;
        msg.className = 'message ' + type;
        msg.style.display = 'block';
        if (type === 'success') {
          document.getElementById('submitBtn').disabled = true;
          setTimeout(()=> location.reload(), 2000);
        }
      }

      // 페이지 초기화
      function init() {
        if (!eventNames[currentEvent]) {
          document.getElementById('errorPage').style.display = 'block';
          return;
        }
        document.getElementById('eventBadge').textContent = eventNames[currentEvent];
        document.getElementById('attendanceForm').style.display = 'block';
        document.getElementById('infoSection').style.display = 'block';
        document.getElementById('attendanceForm').addEventListener('submit', onSubmit);
      }

      // 출석 제출
      function onSubmit(e) {
        e.preventDefault();
        const raw = document.getElementById('phone').value;
        const phone = raw.replace(/[^0-9]/g,'');
        if (phone.length !== 11 || !phone.startsWith('010')) {
          return showMessage('올바른 휴대전화번호를 입력해주세요.', 'error');
        }
        const name = studentList[phone];
        if (!name) {
          return showMessage('등록되지 않은 휴대전화번호입니다.', 'error');
        }
        // 읽기
        let data = {};
        try { data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
        catch { data = {}; }
        // 중복 디바이스 체크
        for (const rec of Object.values(data)) {
          if (rec.events[currentEvent] && rec.events[currentEvent].deviceId === deviceId) {
            return showMessage('이미 이 기기로 다른 교육생이 출석했습니다.', 'error');
          }
        }
        // 중복 번호 체크
        if (data[phone]?.events?.[currentEvent]) {
          return showMessage(name + '님은 이미 출석하셨습니다.', 'error');
        }
        // 저장
        const now = new Date();
        const ts = (now.getMonth()+1).toString().padStart(2,'0') + '/'
                 + now.getDate().toString().padStart(2,'0') + ', '
                 + now.getHours().toString().padStart(2,'0') + ':'
                 + now.getMinutes().toString().padStart(2,'0');
        if (!data[phone]) data[phone] = { name, events:{} };
        data[phone].events[currentEvent] = { timestamp:ts, deviceId };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        showMessage(name + '님, 출석 완료 ('+ts+')', 'success');
      }

      // JSONP 콜백
      window.handleStudentList = function(list) {
        studentList = list;
        init();
      };

      // JSONP 로드 with cache bust
      document.addEventListener('DOMContentLoaded', ()=> {
        const s = document.createElement('script');
        s.src = 'https://script.google.com/macros/s/AKfycbwHysYm9ipYAUU6kF6xPy_xSCF5FoJ0jvCCMzXbNs6BNwxrkMNI3_D4hfcjt_BqBe5NUA/exec'
              + '?callback=handleStudentList&ts=' + Date.now();
        s.onload = ()=> console.log('명단 로드 완료');
        s.onerror = ()=> showMessage('명단 로드에 실패했습니다. 네트워크를 확인하세요.', 'error');
        document.body.appendChild(s);
      });
    })();
  </script>
</body>
</html>
