<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <title>êµìœ¡ ì¶œì„ì²´í¬</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 400px;
      position: relative;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: 90vh;
    }
    
    .event-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .title {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
    }
    
    .error-page {
      display: none;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .error-page h2 {
      color: #721c24;
      margin-bottom: 10px;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    form {
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    input[type="tel"] {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      text-align: center;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input[type="tel"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .submit-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      touch-action: manipulation;
    }
    
    .submit-btn:active {
      transform: scale(0.98);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .message {
      display: none;
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: 600;
      text-align: center;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    .info {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e1e8ed;
      font-size: 14px;
      color: #666;
      text-align: center;
      line-height: 1.6;
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 20px;
      }
      .title {
        font-size: 20px;
      }
      input[type="tel"], .submit-btn {
        font-size: 16px;
      }
    }
    
    /* iOS ì…ë ¥ í•„ë“œ í™•ëŒ€ ë°©ì§€ */
    @supports (-webkit-touch-callout: none) {
      input[type="tel"] {
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div id="eventBadge" class="event-badge" style="display:none;"></div>
    <div class="title">ğŸ“‹ êµìœ¡ ì¶œì„ì²´í¬</div>
    
    <div id="loadingPage" class="loading">
      <div class="spinner"></div>
      <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    
    <div id="errorPage" class="error-page">
      <h2>âš ï¸ ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h2>
      <p>ì˜¬ë°”ë¥¸ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì ‘ì†í•´ì£¼ì„¸ìš”.</p>
    </div>
    
    <form id="attendanceForm" style="display:none;">
      <div class="input-group">
        <label for="phone">íœ´ëŒ€ì „í™”ë²ˆí˜¸</label>
        <input type="tel" 
               id="phone" 
               inputmode="numeric" 
               placeholder="010-1234-5678" 
               maxlength="13" 
               autocomplete="off" 
               required>
      </div>
      <button type="submit" id="submitBtn" class="submit-btn">ì¶œì„ í™•ì¸</button>
    </form>
    
    <div id="message" class="message"></div>
    
    <div id="infoSection" class="info">
      íœ´ëŒ€ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì¶œì„ì²´í¬ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.<br>
      í•˜ì´í”ˆ(-)ì€ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.
    </div>
  </div>

  <script>
    (function() {
      'use strict';
      
      // ìƒìˆ˜ ì •ì˜
      const STORAGE_KEY = 'qrcheckins_attendanceData';
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHysYm9ipYAUU6kF6xPy_xSCF5FoJ0jvCCMzXbNs6BNwxrkMNI3_D4hfcjt_BqBe5NUA/exec';
      const eventNames = {
        day1_morning: '1ì¼ì°¨ ì˜¤ì „ (09:00)',
        day1_evening: '1ì¼ì°¨ ì˜¤í›„ (17:30)',
        day2_morning: '2ì¼ì°¨ ì˜¤ì „ (09:00)',
        day2_evening: '2ì¼ì°¨ ì˜¤í›„ (17:30)'
      };
      
      // ì „ì—­ ë³€ìˆ˜
      let studentList = {};
      let deviceId = null;
      let isProcessing = false;
      const currentEvent = new URLSearchParams(location.search).get('event');
      
      // localStorage ì•ˆì „ ì ‘ê·¼
      function safeStorage() {
        try {
          const test = '__test__';
          localStorage.setItem(test, 'test');
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }
      
      // UUID ìƒì„± (í´ë¦¬í•„ í¬í•¨)
      function generateUUID() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
      
      // Device ID ê°€ì ¸ì˜¤ê¸°/ìƒì„±
      function getDeviceId() {
        if (!safeStorage()) {
          if (!window.sessionDeviceId) {
            window.sessionDeviceId = generateUUID();
          }
          return window.sessionDeviceId;
        }
        
        let id = localStorage.getItem('deviceId');
        if (!id) {
          id = generateUUID();
          try {
            localStorage.setItem('deviceId', id);
          } catch (e) {
            console.warn('Device ID ì €ì¥ ì‹¤íŒ¨');
          }
        }
        return id;
      }
      
      // ë°ì´í„° ì €ì¥
      function saveData(data) {
        if (!safeStorage()) {
          window.tempAttendanceData = data;
          return true;
        }
        
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          return true;
        } catch (e) {
          console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
          if (e.name === 'QuotaExceededError') {
            try {
              // ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
              localStorage.clear();
              localStorage.setItem('deviceId', deviceId);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
              return true;
            } catch (e2) {
              console.error('ì €ì¥ ê³µê°„ ì •ë¦¬ ì‹¤íŒ¨');
            }
          }
          return false;
        }
      }
      
      // ë°ì´í„° ë¡œë“œ
      function loadData() {
        if (!safeStorage()) {
          return window.tempAttendanceData || {};
        }
        
        try {
          const data = localStorage.getItem(STORAGE_KEY);
          return data ? JSON.parse(data) : {};
        } catch (e) {
          console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
          return {};
        }
      }
      
      // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
      function formatPhone(value) {
        const numbers = value.replace(/[^0-9]/g, '');
        let formatted = '';
        
        if (numbers.length <= 3) {
          formatted = numbers;
        } else if (numbers.length <= 7) {
          formatted = numbers.slice(0, 3) + '-' + numbers.slice(3);
        } else {
          formatted = numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7, 11);
        }
        
        return formatted;
      }
      
      // ë©”ì‹œì§€ í‘œì‹œ
      function showMessage(text, type) {
        const el = document.getElementById('message');
        el.textContent = text;
        el.className = 'message ' + type;
        el.style.display = 'block';
        
        if (type === 'success') {
          document.getElementById('submitBtn').disabled = true;
          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      }
      
      // í˜ì´ì§€ ì´ˆê¸°í™”
      function initialize() {
        document.getElementById('loadingPage').style.display = 'none';
        
        if (!eventNames[currentEvent]) {
          document.getElementById('errorPage').style.display = 'block';
          return;
        }
        
        if (!studentList || Object.keys(studentList).length === 0) {
          showMessage('í•™ìƒ ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        
        deviceId = getDeviceId();
        
        document.getElementById('eventBadge').textContent = eventNames[currentEvent];
        document.getElementById('eventBadge').style.display = 'inline-block';
        document.getElementById('attendanceForm').style.display = 'block';
        document.getElementById('infoSection').style.display = 'block';
        
        // ì „í™”ë²ˆí˜¸ ì…ë ¥ í¬ë§·íŒ…
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', function(e) {
          const formatted = formatPhone(e.target.value);
          if (e.target.value !== formatted) {
            e.target.value = formatted;
          }
        });
        
        // í¼ ì œì¶œ í•¸ë“¤ëŸ¬
        document.getElementById('attendanceForm').addEventListener('submit', handleSubmit);
      }
      
      // ì¶œì„ ì²˜ë¦¬
      function handleSubmit(e) {
        e.preventDefault();
        
        if (isProcessing) return;
        isProcessing = true;
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        
        try {
          const raw = document.getElementById('phone').value;
          const phone = raw.replace(/[^0-9]/g, '');
          
          // ìœ íš¨ì„± ê²€ì‚¬
          if (phone.length !== 11 || !phone.startsWith('010')) {
            showMessage('ì˜¬ë°”ë¥¸ íœ´ëŒ€ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
          }
          
          const name = studentList[phone];
          if (!name) {
            showMessage('ë“±ë¡ë˜ì§€ ì•Šì€ íœ´ëŒ€ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error');
            return;
          }
          
          const data = loadData();
          
          // ì¤‘ë³µ ë””ë°”ì´ìŠ¤ ì²´í¬
          for (const [storedPhone, entry] of Object.entries(data)) {
            const record = entry.events && entry.events[currentEvent];
            if (record && record.deviceId === deviceId && storedPhone !== phone) {
              showMessage('ì´ë¯¸ ì´ ê¸°ê¸°ë¡œ ë‹¤ë¥¸ êµìœ¡ìƒì´ ì¶œì„í–ˆìŠµë‹ˆë‹¤.', 'error');
              return;
            }
          }
          
          // ì¤‘ë³µ ì¶œì„ ì²´í¬
          if (data[phone] && data[phone].events && data[phone].events[currentEvent]) {
            showMessage(name + 'ë‹˜ì€ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.', 'warning');
            return;
          }
          
          // íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
          const now = new Date();
          const timestamp = String(now.getMonth() + 1).padStart(2, '0') + '/' +
                          String(now.getDate()).padStart(2, '0') + ', ' +
                          String(now.getHours()).padStart(2, '0') + ':' +
                          String(now.getMinutes()).padStart(2, '0');
          
          // ë°ì´í„° ì €ì¥
          if (!data[phone]) {
            data[phone] = { name: name, events: {} };
          }
          data[phone].events[currentEvent] = {
            timestamp: timestamp,
            deviceId: deviceId
          };
          
          if (saveData(data)) {
            showMessage(name + 'ë‹˜, ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (' + timestamp + ')', 'success');
          } else {
            showMessage('ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
          }
          
        } finally {
          isProcessing = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'ì¶œì„ í™•ì¸';
        }
      }
      
      // JSONP ì½œë°±
      window.handleStudentList = function(list) {
        studentList = list;
        initialize();
      };
      
      // JSONP ë¡œë“œ
      function loadStudentList() {
        document.getElementById('loadingPage').style.display = 'block';
        
        const script = document.createElement('script');
        script.src = SCRIPT_URL + '?callback=handleStudentList&ts=' + Date.now();
        
        const timeout = setTimeout(() => {
          document.getElementById('loadingPage').style.display = 'none';
          showMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
        }, 10000);
        
        script.onload = () => {
          clearTimeout(timeout);
          console.log('í•™ìƒ ëª…ë‹¨ ë¡œë“œ ì™„ë£Œ');
        };
        
        script.onerror = () => {
          clearTimeout(timeout);
          document.getElementById('loadingPage').style.display = 'none';
          showMessage('ëª…ë‹¨ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
        };
        
        document.body.appendChild(script);
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener('DOMContentLoaded', function() {
        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
        if (!navigator.onLine) {
          document.getElementById('loadingPage').style.display = 'none';
          showMessage('ì¸í„°ë„· ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
          return;
        }
        
        loadStudentList();
        
        // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ì´ë²¤íŠ¸
        window.addEventListener('online', () => {
          showMessage('ì¸í„°ë„· ì—°ê²°ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          setTimeout(() => location.reload(), 1000);
        });
        
        window.addEventListener('offline', () => {
          showMessage('ì¸í„°ë„· ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'error');
        });
      });
      
    })();
  </script>
</body>
</html>
