<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¶œì„ì²´í¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <style>
    /* ìƒëµ: ê¸°ì¡´ ê´€ë¦¬ì ìŠ¤íƒ€ì¼ ìœ ì§€ */
  </style>
</head>
<body>
  <script>
    const ADMIN_PW = 'edu2025';
    const pwd = prompt('ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ:');
    if (pwd !== ADMIN_PW) {
      document.body.innerHTML = '<div style="text-align:center;padding:50px;"><h2>ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2></div>';
      throw 'Unauthorized';
    }
  </script>

  <div id="dashboard" style="display:none;">
    <div class="header"><h1>ğŸ“Š ì¶œì„ì²´í¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1><div id="lastUpdate"></div></div>
    <div class="section qr-urls">
      <h3>ğŸ¯ QR ì½”ë“œ ìƒì„±ìš© URL ëª©ë¡</h3>
      <div class="url-item"><div class="url-label">1ì¼ì°¨ ì˜¤ì „</div><div class="url-link" id="url1"></div></div>
      <div class="url-item"><div class="url-label">1ì¼ì°¨ ì˜¤í›„</div><div class="url-link" id="url2"></div></div>
      <div class="url-item"><div class="url-label">2ì¼ì°¨ ì˜¤ì „</div><div class="url-link" id="url3"></div></div>
      <div class="url-item"><div class="url-label">2ì¼ì°¨ ì˜¤í›„</div><div class="url-link" id="url4"></div></div>
    </div>
    <div class="section controls">
      <button onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button onclick="exportData()">ğŸ“Š CSV ë‚´ë³´ë‚´ê¸°</button>
      <button onclick="clearData()" style="background:#dc3545">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
    <div class="section stats">
      <div class="stat-item"><div class="stat-number" id="totalStudents">0</div><div class="stat-label">ì´ êµìœ¡ìƒ</div></div>
      <div class="stat-item"><div class="stat-number" id="totalAttendance">0</div><div class="stat-label">ì „ì²´ ì¶œì„ ê±´ìˆ˜</div></div>
      <div class="stat-item"><div class="stat-number" id="avgAttendanceRate">0%</div><div class="stat-label">í‰ê·  ì¶œì„ë¥ </div></div>
    </div>
    <div class="section">
      <table id="attendanceTable">
        <thead>
          <tr><th>ì´ë¦„</th><th>íœ´ëŒ€ì „í™”ë²ˆí˜¸</th><th>1ì¼ì°¨ ì˜¤ì „</th><th>1ì¼ì°¨ ì˜¤í›„</th><th>2ì¼ì°¨ ì˜¤ì „</th><th>2ì¼ì°¨ ì˜¤í›„</th><th>ì¶œì„ë¥ </th></tr>
        </thead>
        <tbody id="attendanceTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'qrcheckins_attendanceData';
    let studentList = {};
    const events = ['day1_morning','day1_evening','day2_morning','day2_evening'];

    // JSONP ì½œë°±
    function handleStudentList(data) {
      studentList = data;
      initDashboard();
    }

    // ë¡œë“œ í•™ìƒ ëª…ë‹¨
    document.addEventListener('DOMContentLoaded', function() {
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycbwHysYm9ipYAUU6kF6xPy_xSCF5FoJ0jvCCMzXbNs6BNwxrkMNI3_D4hfcjt_BqBe5NUA/exec'
                 + '?callback=handleStudentList&ts=' + Date.now();
      document.body.appendChild(script);
    });

    function initDashboard() {
      document.getElementById('dashboard').style.display = 'block';
      initURLs();
      update();
      setInterval(update, 300000);
    }

    function initURLs() {
      const base = location.origin + location.pathname.replace('admin_dashboard.html','');
      events.forEach((e,i) => {
        document.getElementById('url'+(i+1)).textContent = base + '?event=' + e;
      });
    }

    function loadData() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
      } catch {
        return {};
      }
    }

    function update() {
      const data = loadData();
      const tbody = document.getElementById('attendanceTableBody');
      tbody.innerHTML = '';
      const totalStudents = Object.keys(studentList).length;
      let totalAtt = 0, sumRate = 0;

      Object.entries(studentList).forEach(([phone,name]) => {
        const tr = document.createElement('tr');
        const ev = data[phone]?.events || {};
        let count = 0;

        // ì´ë¦„, ì „í™”ë²ˆí˜¸ ì…€
        const tdName = document.createElement('td'); tdName.textContent = name; tr.appendChild(tdName);
        const tdPhone = document.createElement('td'); tdPhone.textContent = phone.replace(/(\d{3})(\d{4})(\d{4})/,'$1-$2-$3'); tr.appendChild(tdPhone);

        // ì´ë²¤íŠ¸ë³„ ì¶œì„
        events.forEach(evt => {
          const td = document.createElement('td');
          const rec = ev[evt];
          if (rec && rec.timestamp) {
            const timePart = rec.timestamp.split(', ')[1] || rec.timestamp;
            td.innerHTML = `<div style="color:#28a745;font-weight:bold">ì¶œì„</div><div style="font-size:10px;color:#666">${timePart}</div>`;
            count++; totalAtt++;
          } else {
            td.textContent = 'ë¯¸ì¶œì„'; td.style.color = '#dc3545'; td.style.fontWeight = 'bold';
          }
          tr.appendChild(td);
        });

        // ì¶œì„ë¥ 
        const rate = Math.round(count / events.length * 100);
        sumRate += rate;
        const tdRate = document.createElement('td');
        tdRate.textContent = rate + '%';
        tdRate.style.color = rate >= 75 ? '#28a745' : rate >= 50 ? '#ffc107' : '#dc3545';
        tdRate.style.fontWeight = 'bold';
        tr.appendChild(tdRate);

        tbody.appendChild(tr);
      });

      document.getElementById('totalStudents').textContent = totalStudents;
      document.getElementById('totalAttendance').textContent = totalAtt;
      document.getElementById('avgAttendanceRate').textContent = totalStudents ? Math.round(sumRate/totalStudents)+'%' : '0%';
      document.getElementById('lastUpdate').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
    }

    function refreshData() {
      update();
      alert('ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function exportData() {
      const data = loadData();
      const rows = ['Name,Phone,' + events.map(e=>e).join(',') + ',Rate'];
      Object.entries(studentList).forEach(([phone,name]) => {
        const ev = data[phone]?.events || {};
        const parts = events.map(e => ev[e]?.timestamp || 'ë¯¸ì¶œì„');
        const cnt = parts.filter(p => p!=='ë¯¸ì¶œì„').length;
        rows.push(`"${name}","${phone.replace(/(\d{3})(\d{4})(\d{4})/,'$1-$2-$3')}",` + parts.join(',') + ',' + Math.round(cnt/events.length*100)+'%');
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function clearData() {
      if (confirm('ëª¨ë“  ì¶œì„ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem('deviceId');
        update();
        alert('ë°ì´í„°ì™€ ë””ë°”ì´ìŠ¤ IDê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
</body>
</html>
