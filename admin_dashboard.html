<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>출석체크 관리자 대시보드</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .header h1 {
      margin-bottom: 10px;
      font-size: 24px;
    }
    
    #lastUpdate {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .section {
      margin: 20px 0;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .section h3 {
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .qr-urls {
      margin-bottom: 20px;
    }
    
    .url-item {
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .url-label {
      font-weight: bold;
      color: #333;
      margin-right: 10px;
    }
    
    .url-link {
      font-family: monospace;
      word-break: break-all;
      color: #007bff;
      flex: 1;
      margin: 5px 0;
    }
    
    .copy-btn {
      padding: 5px 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-refresh {
      background: #667eea;
      color: white;
    }
    
    .btn-export {
      background: #28a745;
      color: white;
    }
    
    .btn-import {
      background: #17a2b8;
      color: white;
    }
    
    .btn-sync {
      background: #ffc107;
      color: #333;
    }
    
    .btn-clear {
      background: #dc3545;
      color: white;
    }
    
    .btn-share {
      background: #6c757d;
      color: white;
    }
    
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #dee2e6;
    }
    
    th {
      background: #667eea;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    tr:hover {
      background: #e9ecef;
    }
    
    .present {
      color: #28a745;
      font-weight: bold;
    }
    
    .absent {
      color: #dc3545;
      font-weight: bold;
    }
    
    .time-info {
      font-size: 11px;
      color: #6c757d;
      margin-top: 2px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    
    .close-modal {
      float: right;
      font-size: 28px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      line-height: 20px;
    }
    
    .close-modal:hover {
      color: #333;
    }
    
    #qrcode {
      text-align: center;
      margin: 20px 0;
    }
    
    #qrcode canvas {
      margin: 0 auto;
    }
    
    .sync-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .sync-url {
      word-break: break-all;
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      padding: 10px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 5px;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .file-label {
      display: inline-block;
      padding: 10px 20px;
      background: #17a2b8;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .stats {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .controls {
        justify-content: center;
      }
      
      .btn {
        font-size: 12px;
        padding: 8px 15px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 8px 5px;
      }
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .success-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
      z-index: 2000;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="dashboard">
    <div class="header">
      <h1>📊 출석체크 관리자 대시보드</h1>
      <div id="lastUpdate">로딩 중...</div>
    </div>
    
    <div id="errorMsg" class="error" style="display:none;"></div>
    
    <div class="section stats">
      <div class="stat-card">
        <div class="stat-number" id="totalStudents">0</div>
        <div class="stat-label">총 교육생</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAttendance">0</div>
        <div class="stat-label">전체 출석</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgAttendance">0%</div>
        <div class="stat-label">평균 출석률</div>
      </div>
    </div>
    
    <div class="section">
      <h3>🎯 QR 코드 생성용 URL</h3>
      <div class="qr-urls">
        <div class="url-item">
          <span class="url-label">1일차 오전:</span>
          <span class="url-link" id="url1"></span>
          <button class="copy-btn" data-url="url1">복사</button>
        </div>
        <div class="url-item">
          <span class="url-label">1일차 오후:</span>
          <span class="url-link" id="url2"></span>
          <button class="copy-btn" data-url="url2">복사</button>
        </div>
        <div class="url-item">
          <span class="url-label">2일차 오전:</span>
          <span class="url-link" id="url3"></span>
          <button class="copy-btn" data-url="url3">복사</button>
        </div>
        <div class="url-item">
          <span class="url-label">2일차 오후:</span>
          <span class="url-link" id="url4"></span>
          <button class="copy-btn" data-url="url4">복사</button>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h3>🔧 관리 도구</h3>
      <div class="controls">
        <button class="btn btn-refresh" id="refreshBtn">
          🔄 새로고침
        </button>
        <button class="btn btn-export" id="exportBtn">
          📊 CSV 내보내기
        </button>
        <button class="btn btn-export" id="exportJsonBtn">
          💾 JSON 백업
        </button>
        <label for="importFile" class="btn btn-import">
          📁 JSON 복원
        </label>
        <input type="file" id="importFile" accept=".json">
        <button class="btn btn-sync" id="syncBtn">
          📱 데이터 동기화
        </button>
        <button class="btn btn-share" id="shareBtn">
          🔗 PC로 전송
        </button>
        <button class="btn btn-clear" id="clearBtn">
          🗑️ 초기화
        </button>
      </div>
    </div>
    
    <div class="section">
      <h3>📋 출석 현황</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>이름</th>
              <th>전화번호</th>
              <th>1일차 오전</th>
              <th>1일차 오후</th>
              <th>2일차 오전</th>
              <th>2일차 오후</th>
              <th>출석률</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="7" class="loading">데이터를 불러오는 중...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- 동기화 모달 -->
  <div id="syncModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-modal" id="closeSyncModal">&times;</span>
        <div class="modal-title">📱 데이터 동기화</div>
      </div>
      <div id="qrcode"></div>
      <div class="sync-info">
        <p><strong>사용 방법:</strong></p>
        <ol>
          <li>다른 기기에서 이 QR 코드를 스캔하세요</li>
          <li>또는 아래 URL을 복사하여 접속하세요</li>
          <li>데이터가 자동으로 동기화됩니다</li>
        </ol>
        <div class="sync-url" id="syncUrl"></div>
      </div>
    </div>
  </div>

  <!-- QRCode.js 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script>
    (function() {
      'use strict';
      
      // 상수 정의
      const STORAGE_KEY = 'qrcheckins_attendanceData';
      const ADMIN_PW = 'edu2025';
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHysYm9ipYAUU6kF6xPy_xSCF5FoJ0jvCCMzXbNs6BNwxrkMNI3_D4hfcjt_BqBe5NUA/exec';
      const events = ['day1_morning', 'day1_evening', 'day2_morning', 'day2_evening'];
      const eventLabels = {
        day1_morning: '1일차 오전',
        day1_evening: '1일차 오후',
        day2_morning: '2일차 오전',
        day2_evening: '2일차 오후'
      };
      
      // 전역 변수
      let studentList = {};
      let qrCodeInstance = null;
      
      // 인증 체크
      function checkAuth() {
        const urlParams = new URLSearchParams(window.location.search);
        const authParam = urlParams.get('auth');
        const dataParam = urlParams.get('data');
        
        // URL 파라미터로 데이터 전달받은 경우 처리
        if (dataParam) {
          try {
            const importedData = JSON.parse(decodeURIComponent(dataParam));
            if (importedData && typeof importedData === 'object') {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
              showToast('데이터가 성공적으로 동기화되었습니다!');
              // URL 파라미터 제거
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          } catch (e) {
            console.error('데이터 파싱 실패:', e);
          }
        }
        
        // 인증 체크
        if (authParam !== ADMIN_PW) {
          const pwd = prompt('관리자 패스워드를 입력하세요:');
          if (pwd !== ADMIN_PW) {
            document.body.innerHTML = '<h2 style="text-align:center;margin-top:50px;">접근이 거부되었습니다.</h2>';
            throw new Error('Unauthorized');
          }
        }
      }
      
      // localStorage 안전 접근
      function safeStorage() {
        try {
          const test = '__test__';
          localStorage.setItem(test, 'test');
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }
      
      // 데이터 로드
      function loadData() {
        if (!safeStorage()) {
          return {};
        }
        
        try {
          const data = localStorage.getItem(STORAGE_KEY);
          return data ? JSON.parse(data) : {};
        } catch (e) {
          console.error('데이터 로드 실패:', e);
          return {};
        }
      }
      
      // 데이터 저장
      function saveData(data) {
        if (!safeStorage()) {
          showError('저장소에 접근할 수 없습니다.');
          return false;
        }
        
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          return true;
        } catch (e) {
          console.error('데이터 저장 실패:', e);
          showError('데이터 저장에 실패했습니다.');
          return false;
        }
      }
      
      // 토스트 메시지
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'success-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      // 에러 메시지
      function showError(message) {
        const errorEl = document.getElementById('errorMsg');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 5000);
      }
      
      // URL 설정
      function setURLs() {
        const base = location.origin + location.pathname.replace('admin_dashboard.html', 'index.html');
        events.forEach((event, index) => {
          const url = base + '?event=' + event;
          document.getElementById('url' + (index + 1)).textContent = url;
        });
      }
      
      // 테이블 업데이트
      function updateTable() {
        const data = loadData();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        let totalStudents = 0;
        let totalAttendance = 0;
        let sumRate = 0;
        
        // 학생별 출석 데이터 표시
        Object.entries(studentList).forEach(([phone, name]) => {
          totalStudents++;
          const row = document.createElement('tr');
          const studentData = data[phone];
          let attendCount = 0;
          
          // 이름
          const nameCell = document.createElement('td');
          nameCell.textContent = name;
          row.appendChild(nameCell);
          
          // 전화번호
          const phoneCell = document.createElement('td');
          phoneCell.textContent = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
          row.appendChild(phoneCell);
          
          // 각 이벤트별 출석
          events.forEach(event => {
            const cell = document.createElement('td');
            const attendance = studentData?.events?.[event];
            
            if (attendance) {
              const time = attendance.timestamp.split(', ')[1] || attendance.timestamp;
              cell.innerHTML = `
                <div class="present">출석</div>
                <div class="time-info">${time}</div>
              `;
              attendCount++;
              totalAttendance++;
            } else {
              cell.innerHTML = '<div class="absent">미출석</div>';
            }
            
            row.appendChild(cell);
          });
          
          // 출석률
          const rate = Math.round((attendCount / events.length) * 100);
          sumRate += rate;
          
          const rateCell = document.createElement('td');
          rateCell.innerHTML = `<strong style="color: ${rate >= 75 ? '#28a745' : rate >= 50 ? '#ffc107' : '#dc3545'}">${rate}%</strong>`;
          row.appendChild(rateCell);
          
          tbody.appendChild(row);
        });
        
        // 통계 업데이트
        document.getElementById('totalStudents').textContent = totalStudents;
        document.getElementById('totalAttendance').textContent = totalAttendance;
        document.getElementById('avgAttendance').textContent = totalStudents > 0 
          ? Math.round(sumRate / totalStudents) + '%' 
          : '0%';
        
        // 마지막 업데이트 시간
        const now = new Date();
        document.getElementById('lastUpdate').textContent = 
          '마지막 업데이트: ' + now.toLocaleString('ko-KR');
      }
      
      // CSV 내보내기
      function exportCSV() {
        const data = loadData();
        const rows = ['이름,전화번호,' + events.map(e => eventLabels[e]).join(',') + ',출석률'];
        
        Object.entries(studentList).forEach(([phone, name]) => {
          const studentData = data[phone];
          const attendances = events.map(event => 
            studentData?.events?.[event] ? studentData.events[event].timestamp : '미출석'
          );
          const attendCount = attendances.filter(a => a !== '미출석').length;
          const rate = Math.round((attendCount / events.length) * 100);
          
          rows.push(`"${name}","${phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3')}",${attendances.join(',')},${rate}%`);
        });
        
        const csv = '\ufeff' + rows.join('\n'); // UTF-8 BOM 추가
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `출석체크_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showToast('CSV 파일이 다운로드되었습니다.');
      }
      
      // JSON 백업
      function exportJSON() {
        const data = loadData();
        const exportData = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          studentList: studentList,
          attendanceData: data
        };
        
        const json = JSON.stringify(exportData, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `출석체크_백업_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showToast('백업 파일이 생성되었습니다.');
      }
      
      // JSON 복원
      function importJSON(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const importData = JSON.parse(e.target.result);
            
            if (importData.attendanceData) {
              if (saveData(importData.attendanceData)) {
                updateTable();
                showToast('데이터가 성공적으로 복원되었습니다.');
              }
            } else {
              showError('올바른 백업 파일이 아닙니다.');
            }
          } catch (err) {
            console.error('Import error:', err);
            showError('파일을 읽을 수 없습니다.');
          }
        };
        
        reader.readAsText(file);
      }
      
      // 데이터 동기화 (QR 코드 생성)
      function showSyncModal() {
        const modal = document.getElementById('syncModal');
        modal.style.display = 'flex';
        
        const data = loadData();
        const encodedData = encodeURIComponent(JSON.stringify(data));
        
        // URL이 너무 길 경우 처리
        let syncUrl;
        if (encodedData.length > 2000) {
          // 데이터가 너무 크면 수동 import 안내
          syncUrl = location.origin + location.pathname + '?auth=' + ADMIN_PW;
          document.querySelector('.sync-info').innerHTML = `
            <p><strong>⚠️ 데이터가 너무 큽니다</strong></p>
            <p>JSON 백업/복원 기능을 사용해주세요.</p>
            <ol>
              <li>현재 기기에서 "JSON 백업" 버튼 클릭</li>
              <li>다른 기기에서 아래 URL 접속</li>
              <li>"JSON 복원" 버튼으로 백업 파일 업로드</li>
            </ol>
            <div class="sync-url" id="syncUrl">${syncUrl}</div>
          `;
        } else {
          syncUrl = location.origin + location.pathname + '?auth=' + ADMIN_PW + '&data=' + encodedData;
          document.getElementById('syncUrl').textContent = syncUrl;
        }
        
        // QR 코드 생성
        const qrcodeEl = document.getElementById('qrcode');
        qrcodeEl.innerHTML = '';
        
        try {
          qrCodeInstance = new QRCode(qrcodeEl, {
            text: syncUrl,
            width: 256,
            height: 256,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.L
          });
        } catch (e) {
          console.error('QR 코드 생성 실패:', e);
          qrcodeEl.innerHTML = '<p>QR 코드를 생성할 수 없습니다.</p>';
        }
      }
      
      // PC로 전송 (간단한 URL 공유)
      function shareToPC() {
        const data = loadData();
        const encodedData = encodeURIComponent(JSON.stringify(data));
        
        if (encodedData.length > 2000) {
          showError('데이터가 너무 큽니다. JSON 백업 기능을 사용해주세요.');
          return;
        }
        
        const shareUrl = location.origin + location.pathname + '?auth=' + ADMIN_PW + '&data=' + encodedData;
        
        // 클립보드에 복사
        if (navigator.clipboard) {
          navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('URL이 클립보드에 복사되었습니다. PC에서 붙여넣기하세요.');
          }).catch(() => {
            prompt('이 URL을 복사하여 PC에서 접속하세요:', shareUrl);
          });
        } else {
          prompt('이 URL을 복사하여 PC에서 접속하세요:', shareUrl);
        }
      }
      
      // 데이터 초기화
      function clearData() {
        if (confirm('모든 출석 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
          if (confirm('정말로 삭제하시겠습니까?')) {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem('deviceId');
            updateTable();
            showToast('모든 데이터가 초기화되었습니다.');
          }
        }
      }
      
      // URL 복사
      function copyURL(urlId) {
        const url = document.getElementById(urlId).textContent;
        
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).then(() => {
            showToast('URL이 복사되었습니다.');
          }).catch(() => {
            fallbackCopy(url);
          });
        } else {
          fallbackCopy(url);
        }
      }
      
      function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
          document.execCommand('copy');
          showToast('URL이 복사되었습니다.');
        } catch (e) {
          prompt('URL을 복사하세요:', text);
        }
        
        document.body.removeChild(textarea);
      }
      
      // 이벤트 리스너 설정
      function setupEventListeners() {
        // 새로고침
        document.getElementById('refreshBtn').addEventListener('click', function() {
          updateTable();
          showToast('데이터가 새로고침되었습니다.');
        });
        
        // CSV 내보내기
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        
        // JSON 백업
        document.getElementById('exportJsonBtn').addEventListener('click', exportJSON);
        
        // JSON 복원
        document.getElementById('importFile').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            importJSON(file);
            e.target.value = ''; // 파일 입력 초기화
          }
        });
        
        // 데이터 동기화
        document.getElementById('syncBtn').addEventListener('click', showSyncModal);
        
        // PC로 전송
        document.getElementById('shareBtn').addEventListener('click', shareToPC);
        
        // 초기화
        document.getElementById('clearBtn').addEventListener('click', clearData);
        
        // URL 복사 버튼들
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            copyURL(this.dataset.url);
          });
        });
        
        // 모달 닫기
        document.getElementById('closeSyncModal').addEventListener('click', function() {
          document.getElementById('syncModal').style.display = 'none';
        });
        
        // 모달 외부 클릭 시 닫기
        document.getElementById('syncModal').addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      }
      
      // JSONP 콜백
      window.handleStudentList = function(list) {
        studentList = list;
        initDashboard();
      };
      
      // 대시보드 초기화
      function initDashboard() {
        setURLs();
        updateTable();
        setupEventListeners();
        
        // 5분마다 자동 새로고침
        setInterval(updateTable, 300000);
      }
      
      // 학생 명단 로드
      function loadStudentList() {
        const script = document.createElement('script');
        script.src = SCRIPT_URL + '?callback=handleStudentList&ts=' + Date.now();
        
        script.onerror = function() {
          showError('학생 명단 로드에 실패했습니다.');
          // 명단 없이도 기존 데이터는 표시
          studentList = {};
          const data = loadData();
          Object.entries(data).forEach(([phone, info]) => {
            if (info.name) {
              studentList[phone] = info.name;
            }
          });
          initDashboard();
        };
        
        document.body.appendChild(script);
      }
      
      // 페이지 로드 시 실행
      document.addEventListener('DOMContentLoaded', function() {
        try {
          checkAuth();
          loadStudentList();
        } catch (e) {
          console.error('초기화 실패:', e);
        }
      });
      
    })();
  </script>
</body>
</html>
