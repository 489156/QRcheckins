<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¶œì„ì²´í¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .header h1 {
      margin-bottom: 10px;
      font-size: 24px;
    }
    
    #lastUpdate {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .section {
      margin: 20px 0;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .section h3 {
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .qr-urls {
      margin-bottom: 20px;
    }
    
    .url-item {
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .url-label {
      font-weight: bold;
      color: #333;
      margin-right: 10px;
    }
    
    .url-link {
      font-family: monospace;
      word-break: break-all;
      color: #007bff;
      flex: 1;
      margin: 5px 0;
    }
    
    .copy-btn {
      padding: 5px 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-refresh {
      background: #667eea;
      color: white;
    }
    
    .btn-export {
      background: #28a745;
      color: white;
    }
    
    .btn-import {
      background: #17a2b8;
      color: white;
    }
    
    .btn-sync {
      background: #ffc107;
      color: #333;
    }
    
    .btn-clear {
      background: #dc3545;
      color: white;
    }
    
    .btn-share {
      background: #6c757d;
      color: white;
    }
    
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #dee2e6;
    }
    
    th {
      background: #667eea;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    tr:hover {
      background: #e9ecef;
    }
    
    .present {
      color: #28a745;
      font-weight: bold;
    }
    
    .absent {
      color: #dc3545;
      font-weight: bold;
    }
    
    .time-info {
      font-size: 11px;
      color: #6c757d;
      margin-top: 2px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    
    .close-modal {
      float: right;
      font-size: 28px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      line-height: 20px;
    }
    
    .close-modal:hover {
      color: #333;
    }
    
    #qrcode {
      text-align: center;
      margin: 20px 0;
    }
    
    #qrcode canvas {
      margin: 0 auto;
    }
    
    .sync-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .sync-url {
      word-break: break-all;
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      padding: 10px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 5px;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .file-label {
      display: inline-block;
      padding: 10px 20px;
      background: #17a2b8;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .stats {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .controls {
        justify-content: center;
      }
      
      .btn {
        font-size: 12px;
        padding: 8px 15px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 8px 5px;
      }
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .success-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
      z-index: 2000;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="dashboard">
    <div class="header">
      <h1>ğŸ“Š ì¶œì„ì²´í¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <div id="lastUpdate">ë¡œë”© ì¤‘...</div>
    </div>
    
    <div id="errorMsg" class="error" style="display:none;"></div>
    
    <div class="section stats">
      <div class="stat-card">
        <div class="stat-number" id="totalStudents">0</div>
        <div class="stat-label">ì´ êµìœ¡ìƒ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAttendance">0</div>
        <div class="stat-label">ì „ì²´ ì¶œì„</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgAttendance">0%</div>
        <div class="stat-label">í‰ê·  ì¶œì„ë¥ </div>
      </div>
    </div>
    
    <div class="section">
      <h3>ğŸ¯ QR ì½”ë“œ ìƒì„±ìš© URL</h3>
      <div class="qr-urls">
        <div class="url-item">
          <span class="url-label">1ì¼ì°¨ ì˜¤ì „:</span>
          <span class="url-link" id="url1"></span>
          <button class="copy-btn" data-url="url1">ë³µì‚¬</button>
        </div>
        <div class="url-item">
          <span class="url-label">1ì¼ì°¨ ì˜¤í›„:</span>
          <span class="url-link" id="url2"></span>
          <button class="copy-btn" data-url="url2">ë³µì‚¬</button>
        </div>
        <div class="url-item">
          <span class="url-label">2ì¼ì°¨ ì˜¤ì „:</span>
          <span class="url-link" id="url3"></span>
          <button class="copy-btn" data-url="url3">ë³µì‚¬</button>
        </div>
        <div class="url-item">
          <span class="url-label">2ì¼ì°¨ ì˜¤í›„:</span>
          <span class="url-link" id="url4"></span>
          <button class="copy-btn" data-url="url4">ë³µì‚¬</button>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h3>ğŸ”§ ê´€ë¦¬ ë„êµ¬</h3>
      <div class="controls">
        <button class="btn btn-refresh" id="refreshBtn">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
        <button class="btn btn-export" id="exportBtn">
          ğŸ“Š CSV ë‚´ë³´ë‚´ê¸°
        </button>
        <button class="btn btn-export" id="exportJsonBtn">
          ğŸ’¾ JSON ë°±ì—…
        </button>
        <label for="importFile" class="btn btn-import">
          ğŸ“ JSON ë³µì›
        </label>
        <input type="file" id="importFile" accept=".json">
        <button class="btn btn-sync" id="syncBtn">
          ğŸ“± ë°ì´í„° ë™ê¸°í™”
        </button>
        <button class="btn btn-share" id="shareBtn">
          ğŸ”— PCë¡œ ì „ì†¡
        </button>
        <button class="btn btn-clear" id="clearBtn">
          ğŸ—‘ï¸ ì´ˆê¸°í™”
        </button>
      </div>
    </div>
    
    <div class="section">
      <h3>ğŸ“‹ ì¶œì„ í˜„í™©</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ì „í™”ë²ˆí˜¸</th>
              <th>1ì¼ì°¨ ì˜¤ì „</th>
              <th>1ì¼ì°¨ ì˜¤í›„</th>
              <th>2ì¼ì°¨ ì˜¤ì „</th>
              <th>2ì¼ì°¨ ì˜¤í›„</th>
              <th>ì¶œì„ë¥ </th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="7" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- ë™ê¸°í™” ëª¨ë‹¬ -->
  <div id="syncModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-modal" id="closeSyncModal">&times;</span>
        <div class="modal-title">ğŸ“± ë°ì´í„° ë™ê¸°í™”</div>
      </div>
      <div id="qrcode"></div>
      <div class="sync-info">
        <p><strong>ì‚¬ìš© ë°©ë²•:</strong></p>
        <ol>
          <li>ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì´ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</li>
          <li>ë˜ëŠ” ì•„ë˜ URLì„ ë³µì‚¬í•˜ì—¬ ì ‘ì†í•˜ì„¸ìš”</li>
          <li>ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤</li>
        </ol>
        <div class="sync-url" id="syncUrl"></div>
      </div>
    </div>
  </div>

  <!-- QRCode.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script>
    (function() {
      'use strict';
      
      // ìƒìˆ˜ ì •ì˜
      const STORAGE_KEY = 'qrcheckins_attendanceData';
      const ADMIN_PW = 'edu2025';
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHysYm9ipYAUU6kF6xPy_xSCF5FoJ0jvCCMzXbNs6BNwxrkMNI3_D4hfcjt_BqBe5NUA/exec';
      const events = ['day1_morning', 'day1_evening', 'day2_morning', 'day2_evening'];
      const eventLabels = {
        day1_morning: '1ì¼ì°¨ ì˜¤ì „',
        day1_evening: '1ì¼ì°¨ ì˜¤í›„',
        day2_morning: '2ì¼ì°¨ ì˜¤ì „',
        day2_evening: '2ì¼ì°¨ ì˜¤í›„'
      };
      
      // ì „ì—­ ë³€ìˆ˜
      let studentList = {};
      let qrCodeInstance = null;
      
      // ì¸ì¦ ì²´í¬
      function checkAuth() {
        const urlParams = new URLSearchParams(window.location.search);
        const authParam = urlParams.get('auth');
        const dataParam = urlParams.get('data');
        
        // URL íŒŒë¼ë¯¸í„°ë¡œ ë°ì´í„° ì „ë‹¬ë°›ì€ ê²½ìš° ì²˜ë¦¬
        if (dataParam) {
          try {
            const importedData = JSON.parse(decodeURIComponent(dataParam));
            if (importedData && typeof importedData === 'object') {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
              showToast('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
              // URL íŒŒë¼ë¯¸í„° ì œê±°
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          } catch (e) {
            console.error('ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
          }
        }
        
        // ì¸ì¦ ì²´í¬
        if (authParam !== ADMIN_PW) {
          const pwd = prompt('ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
          if (pwd !== ADMIN_PW) {
            document.body.innerHTML = '<h2 style="text-align:center;margin-top:50px;">ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.</h2>';
            throw new Error('Unauthorized');
          }
        }
      }
      
      // localStorage ì•ˆì „ ì ‘ê·¼
      function safeStorage() {
        try {
          const test = '__test__';
          localStorage.setItem(test, 'test');
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }
      
      // ë°ì´í„° ë¡œë“œ
      function loadData() {
        if (!safeStorage()) {
          return {};
        }
        
        try {
          const data = localStorage.getItem(STORAGE_KEY);
          return data ? JSON.parse(data) : {};
        } catch (e) {
          console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
          return {};
        }
      }
      
      // ë°ì´í„° ì €ì¥
      function saveData(data) {
        if (!safeStorage()) {
          showError('ì €ì¥ì†Œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return false;
        }
        
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          return true;
        } catch (e) {
          console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
          showError('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          return false;
        }
      }
      
      // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'success-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      // ì—ëŸ¬ ë©”ì‹œì§€
      function showError(message) {
        const errorEl = document.getElementById('errorMsg');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 5000);
      }
      
      // URL ì„¤ì •
      function setURLs() {
        const base = location.origin + location.pathname.replace('admin_dashboard.html', 'index.html');
        events.forEach((event, index) => {
          const url = base + '?event=' + event;
          document.getElementById('url' + (index + 1)).textContent = url;
        });
      }
      
      // í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateTable() {
        const data = loadData();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        let totalStudents = 0;
        let totalAttendance = 0;
        let sumRate = 0;
        
        // í•™ìƒë³„ ì¶œì„ ë°ì´í„° í‘œì‹œ
        Object.entries(studentList).forEach(([phone, name]) => {
          totalStudents++;
          const row = document.createElement('tr');
          const studentData = data[phone];
          let attendCount = 0;
          
          // ì´ë¦„
          const nameCell = document.createElement('td');
          nameCell.textContent = name;
          row.appendChild(nameCell);
          
          // ì „í™”ë²ˆí˜¸
          const phoneCell = document.createElement('td');
          phoneCell.textContent = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
          row.appendChild(phoneCell);
          
          // ê° ì´ë²¤íŠ¸ë³„ ì¶œì„
          events.forEach(event => {
            const cell = document.createElement('td');
            const attendance = studentData?.events?.[event];
            
            if (attendance) {
              const time = attendance.timestamp.split(', ')[1] || attendance.timestamp;
              cell.innerHTML = `
                <div class="present">ì¶œì„</div>
                <div class="time-info">${time}</div>
              `;
              attendCount++;
              totalAttendance++;
            } else {
              cell.innerHTML = '<div class="absent">ë¯¸ì¶œì„</div>';
            }
            
            row.appendChild(cell);
          });
          
          // ì¶œì„ë¥ 
          const rate = Math.round((attendCount / events.length) * 100);
          sumRate += rate;
          
          const rateCell = document.createElement('td');
          rateCell.innerHTML = `<strong style="color: ${rate >= 75 ? '#28a745' : rate >= 50 ? '#ffc107' : '#dc3545'}">${rate}%</strong>`;
          row.appendChild(rateCell);
          
          tbody.appendChild(row);
        });
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('totalStudents').textContent = totalStudents;
        document.getElementById('totalAttendance').textContent = totalAttendance;
        document.getElementById('avgAttendance').textContent = totalStudents > 0 
          ? Math.round(sumRate / totalStudents) + '%' 
          : '0%';
        
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        const now = new Date();
        document.getElementById('lastUpdate').textContent = 
          'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + now.toLocaleString('ko-KR');
      }
      
      // CSV ë‚´ë³´ë‚´ê¸°
      function exportCSV() {
        const data = loadData();
        const rows = ['ì´ë¦„,ì „í™”ë²ˆí˜¸,' + events.map(e => eventLabels[e]).join(',') + ',ì¶œì„ë¥ '];
        
        Object.entries(studentList).forEach(([phone, name]) => {
          const studentData = data[phone];
          const attendances = events.map(event => 
            studentData?.events?.[event] ? studentData.events[event].timestamp : 'ë¯¸ì¶œì„'
          );
          const attendCount = attendances.filter(a => a !== 'ë¯¸ì¶œì„').length;
          const rate = Math.round((attendCount / events.length) * 100);
          
          rows.push(`"${name}","${phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3')}",${attendances.join(',')},${rate}%`);
        });
        
        const csv = '\ufeff' + rows.join('\n'); // UTF-8 BOM ì¶”ê°€
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ì¶œì„ì²´í¬_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showToast('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      
      // JSON ë°±ì—…
      function exportJSON() {
        const data = loadData();
        const exportData = {
          version: '1.0',
          exportDate: new Date().toISOString(),
          studentList: studentList,
          attendanceData: data
        };
        
        const json = JSON.stringify(exportData, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ì¶œì„ì²´í¬_ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showToast('ë°±ì—… íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      
      // JSON ë³µì›
      function importJSON(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const importData = JSON.parse(e.target.result);
            
            if (importData.attendanceData) {
              if (saveData(importData.attendanceData)) {
                updateTable();
                showToast('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
              }
            } else {
              showError('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
            }
          } catch (err) {
            console.error('Import error:', err);
            showError('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        };
        
        reader.readAsText(file);
      }
      
      // ë°ì´í„° ë™ê¸°í™” (QR ì½”ë“œ ìƒì„±)
      function showSyncModal() {
        const modal = document.getElementById('syncModal');
        modal.style.display = 'flex';
        
        const data = loadData();
        const encodedData = encodeURIComponent(JSON.stringify(data));
        
        // URLì´ ë„ˆë¬´ ê¸¸ ê²½ìš° ì²˜ë¦¬
        let syncUrl;
        if (encodedData.length > 2000) {
          // ë°ì´í„°ê°€ ë„ˆë¬´ í¬ë©´ ìˆ˜ë™ import ì•ˆë‚´
          syncUrl = location.origin + location.pathname + '?auth=' + ADMIN_PW;
          document.querySelector('.sync-info').innerHTML = `
            <p><strong>âš ï¸ ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤</strong></p>
            <p>JSON ë°±ì—…/ë³µì› ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
            <ol>
              <li>í˜„ì¬ ê¸°ê¸°ì—ì„œ "JSON ë°±ì—…" ë²„íŠ¼ í´ë¦­</li>
              <li>ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì•„ë˜ URL ì ‘ì†</li>
              <li>"JSON ë³µì›" ë²„íŠ¼ìœ¼ë¡œ ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ</li>
            </ol>
            <div class="sync-url" id="syncUrl">${syncUrl}</div>
          `;
        } else {
          syncUrl = location.origin + location.pathname + '?auth=' + ADMIN_PW + '&data=' + encodedData;
          document.getElementById('syncUrl').textContent = syncUrl;
        }
        
        // QR ì½”ë“œ ìƒì„±
        const qrcodeEl = document.getElementById('qrcode');
        qrcodeEl.innerHTML = '';
        
        try {
          qrCodeInstance = new QRCode(qrcodeEl, {
            text: syncUrl,
            width: 256,
            height: 256,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.L
          });
        } catch (e) {
          console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', e);
          qrcodeEl.innerHTML = '<p>QR ì½”ë“œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      }
      
      // PCë¡œ ì „ì†¡ (ê°„ë‹¨í•œ URL ê³µìœ )
      function shareToPC() {
        const data = loadData();
        const encodedData = encodeURIComponent(JSON.stringify(data));
        
        if (encodedData.length > 2000) {
          showError('ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. JSON ë°±ì—… ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        const shareUrl = location.origin + location.pathname + '?auth=' + ADMIN_PW + '&data=' + encodedData;
        
        // í´ë¦½ë³´ë“œì— ë³µì‚¬
        if (navigator.clipboard) {
          navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. PCì—ì„œ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”.');
          }).catch(() => {
            prompt('ì´ URLì„ ë³µì‚¬í•˜ì—¬ PCì—ì„œ ì ‘ì†í•˜ì„¸ìš”:', shareUrl);
          });
        } else {
          prompt('ì´ URLì„ ë³µì‚¬í•˜ì—¬ PCì—ì„œ ì ‘ì†í•˜ì„¸ìš”:', shareUrl);
        }
      }
      
      // ë°ì´í„° ì´ˆê¸°í™”
      function clearData() {
        if (confirm('ëª¨ë“  ì¶œì„ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          if (confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem('deviceId');
            updateTable();
            showToast('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
        }
      }
      
      // URL ë³µì‚¬
      function copyURL(urlId) {
        const url = document.getElementById(urlId).textContent;
        
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).then(() => {
            showToast('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }).catch(() => {
            fallbackCopy(url);
          });
        } else {
          fallbackCopy(url);
        }
      }
      
      function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
          document.execCommand('copy');
          showToast('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) {
          prompt('URLì„ ë³µì‚¬í•˜ì„¸ìš”:', text);
        }
        
        document.body.removeChild(textarea);
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      function setupEventListeners() {
        // ìƒˆë¡œê³ ì¹¨
        document.getElementById('refreshBtn').addEventListener('click', function() {
          updateTable();
          showToast('ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        
        // CSV ë‚´ë³´ë‚´ê¸°
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        
        // JSON ë°±ì—…
        document.getElementById('exportJsonBtn').addEventListener('click', exportJSON);
        
        // JSON ë³µì›
        document.getElementById('importFile').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            importJSON(file);
            e.target.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
          }
        });
        
        // ë°ì´í„° ë™ê¸°í™”
        document.getElementById('syncBtn').addEventListener('click', showSyncModal);
        
        // PCë¡œ ì „ì†¡
        document.getElementById('shareBtn').addEventListener('click', shareToPC);
        
        // ì´ˆê¸°í™”
        document.getElementById('clearBtn').addEventListener('click', clearData);
        
        // URL ë³µì‚¬ ë²„íŠ¼ë“¤
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            copyURL(this.dataset.url);
          });
        });
        
        // ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('closeSyncModal').addEventListener('click', function() {
          document.getElementById('syncModal').style.display = 'none';
        });
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('syncModal').addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      }
      
      // JSONP ì½œë°±
      window.handleStudentList = function(list) {
        studentList = list;
        initDashboard();
      };
      
      // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
      function initDashboard() {
        setURLs();
        updateTable();
        setupEventListeners();
        
        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(updateTable, 300000);
      }
      
      // í•™ìƒ ëª…ë‹¨ ë¡œë“œ
      function loadStudentList() {
        const script = document.createElement('script');
        script.src = SCRIPT_URL + '?callback=handleStudentList&ts=' + Date.now();
        
        script.onerror = function() {
          showError('í•™ìƒ ëª…ë‹¨ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          // ëª…ë‹¨ ì—†ì´ë„ ê¸°ì¡´ ë°ì´í„°ëŠ” í‘œì‹œ
          studentList = {};
          const data = loadData();
          Object.entries(data).forEach(([phone, info]) => {
            if (info.name) {
              studentList[phone] = info.name;
            }
          });
          initDashboard();
        };
        
        document.body.appendChild(script);
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      document.addEventListener('DOMContentLoaded', function() {
        try {
          checkAuth();
          loadStudentList();
        } catch (e) {
          console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
        }
      });
      
    })();
  </script>
</body>
</html>
